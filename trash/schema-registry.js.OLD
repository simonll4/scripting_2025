import Ajv from "ajv";
import addFormats from "ajv-formats";

// Importar validators de ambos sistemas
import { validators as businessValidators } from "./business/modules.index.js";
import { protocolValidators } from "./protocol/commands/protocol.index.js";

const ajv = new Ajv({
  allErrors: true,
  coerceTypes: true, // "60" -> 60
  useDefaults: true, // aplica default del schema
  removeAdditional: true, // borra props no permitidas
  strict: false, // para dev; en prod podés activar true
});
addFormats(ajv);

// Combinar validators de protocolo y negocio
export const validators = new Map([
  ...protocolValidators, // Comandos de protocolo (AUTH, etc.)
  ...businessValidators, // Módulos de negocio (GET_OS_INFO, etc.)
]);

console.log(
  `Registry unificado: ${protocolValidators.size} protocolo + ${businessValidators.size} negocio = ${validators.size} total`
);

// Helper para compactar errores
export const formatAjvErrors = (errs) =>
  errs?.map((e) => `${e.instancePath || "/"} ${e.message}`).slice(0, 5);
