# 00 -- Resumen general y arquitectura

## Resumen ejecutivo

Este documento describe la **arquitectura global** de una solución local
para generar y consultar un catálogo de grabaciones **relevantes**
procedentes de cámaras de vídeo. La solución permite detectar eventos de
interés en tiempo real con un **Agente en el borde (Edge Agent)**,
grabar únicamente los intervalos relevantes en un plano de medios
mediante **MediaMTX**, almacenar metadatos de sesiones y detecciones en
un **Session Store**, enriquecer esas detecciones con atributos como
color mediante un **Attribute Enricher**, guardar miniaturas y marcos en
un **Object Storage** local y, finalmente, ofrecer a un **App UI** una
API para consultar y reproducir las sesiones filtrando por clases o
atributos. La solución está orientada a un laboratorio/desarrollo y **no
utiliza TLS ni proxies inversos**; todos los servicios se exponen en
puertos locales accesibles vía HTTP.

## Plano de medios vs plano de control

La arquitectura se divide en dos planos lógicos:

-   **Plano de medios**: se encarga del transporte y grabación de flujos
    de vídeo. El Edge Agent arranca y detiene un pipeline de *GStreamer*
    para cada sesión relevante y publica el flujo a MediaMTX. MediaMTX
    graba las sesiones en formato **HLS/fMP4**, generando un archivo
    `.m3u8` (playlist) y segmentos `.m4s` por sesión.
-   **Plano de control**: se ocupa de las decisiones de relevancia,
    almacenamiento de metadatos y de exponer una API de consultas.
    Incluye el Edge Agent (detección y control de sesiones), el
    Session Store (persistencia de sesiones y detecciones), el
    Attribute Enricher (enriquecimiento de atributos) y el
    Object Storage (almacenamiento de marcos y miniaturas).

La App UI se apoya en ambos planos: consulta al Session Store para
listar sesiones y reproduce las grabaciones a través de MediaMTX.

## Mapa de puertos y servicios

En un entorno local sin proxies ni TLS, cada módulo escucha en un puerto
específico. La tabla siguiente resume los valores recomendados; se
pueden ajustar mediante variables de entorno de cada servicio:

  -------------------------------------------------------------------------------------------------------------
  Módulo                   Puerto predeterminado   Endpoints principales
  ------------------------ ----------------------- ------------------------------------------------------------
  **Edge Agent**           --- (cliente)           Se conecta a MediaMTX y Session Store.

  **MediaMTX**             **8888/tcp**            `http://localhost:8888/recordings/{session_id}/index.m3u8`
                                                   para reproducción HLS.

  **Session Store**        **8080/tcp**            `POST /sessions/open`, `POST /sessions/close`,
                                                   `POST /detections/batch`, `POST /query`.

  **Attribute Enricher**   **8081/tcp**            `POST /enrich` para enriquecer detecciones (opcional si se
                                                   integra en el Store).

  **Object Storage**       **8090/tcp**            Servidor de archivos simple para `/frames` y `/thumbs`.

  **App UI**               **3000/tcp**            Aplicación Vue.js que se comunica con Session Store y
                                                   MediaMTX.
  -------------------------------------------------------------------------------------------------------------

> **Nota:** se recomienda mantener todos los servicios en la misma
> máquina y red local para evitar problemas de seguridad. La ausencia de
> TLS se justifica por ser un entorno de laboratorio; en entornos
> productivos se debería habilitar HTTPS y autenticación.

## Glosario

  -----------------------------------------------------------------------
  Término                             Definición
  ----------------------------------- -----------------------------------
  **Sesión**                          Intervalo continuo de grabación
                                      iniciado cuando el Edge Agent
                                      detecta el primer evento relevante
                                      y cerrado tras un periodo de
                                      *post‑roll* sin detecciones.
                                      Identificado por `session_id`.

  **Evento**                          Notificación interna (no expuesta
                                      al usuario) generada por el
                                      Edge Agent al abrir o cerrar una
                                      sesión y al publicar detecciones.

  **Detección**                       Resultado de la inferencia del
                                      modelo ONNX: incluye clase,
                                      puntuación (`score`), *bounding
                                      box* y marcas de tiempo
                                      (`first_ts`/`last_ts`).

  **start_pdt / end_pdt**             Timestamps absolutos en formato
                                      RFC 3339, derivados de los campos
                                      `edge_start_ts` y `edge_end_ts`
                                      pero alineados con la hora de
                                      MediaMTX mediante
                                      *PROGRAM‑DATE‑TIME* en HLS. Indican
                                      el inicio y el fin reproducibles de
                                      la sesión.

  **playlist_url**                    URL al archivo `.m3u8` generado por
                                      MediaMTX para una sesión. Utilizado
                                      por el reproductor HLS.

  **meta_url**                        Ruta (normalmente en
                                      Object Storage) al archivo JSON con
                                      las anotaciones frame a frame,
                                      generado por el Edge Agent y
                                      almacenado por el Session Store.

  **thumb_url**                       Ruta al archivo JPEG de la
                                      miniatura representativa de la
                                      sesión.

  **existen/noExisten**               Listas de tokens de búsqueda usadas
                                      por `POST /query`. Un token puede
                                      ser una clase (`"persona"`) o una
                                      combinación clase:atributo
                                      (`"sombrero:red"`). `existen`
                                      requiere que al menos una detección
                                      por token exista; `noExisten`
                                      filtra sesiones que contengan ese
                                      token.
  -----------------------------------------------------------------------

## Diagrama de contenedores

La siguiente representación en Mermaid ilustra los componentes
principales y sus interacciones en el despliegue local. Cada flecha
indica un flujo lógico o de datos:

    flowchart LR
      subgraph Edge
        Camera[[Cámara]] -- frames --> EdgeAgent(("Edge Agent"))
        EdgeAgent -- detecciones relevantes --> InferenceEngine[["Inference Engine\n(Mod 1)"]]
        EdgeAgent -- stream HLS --> StreamProcessor[["Stream Processor\n(Mod 3)"]]
      end
      EdgeAgent -- open/close + detections --> SessionStore(("Session Store"))
      EdgeAgent -- streaming cuando activo --> MediaMTX((MediaMTX))
      SessionStore -- query(existen, noExisten) --> AppUI(("App UI"))
      MediaMTX -- GET (playback) --> AppUI
      SessionStore -- actualiza atributos --> AttributeEnricher(("Attribute Enricher"))
      SessionStore -- metadatos: meta_url, thumb_url --> ObjectStorage(("Object Storage"))
      AttributeEnricher -- lee frames --> ObjectStorage
      AppUI -- descarga miniaturas y metadatos --> ObjectStorage

### Consideraciones de despliegue local

-   **Sin TLS/SSL ni proxies inversos**: todos los servicios escuchan en
    HTTP y en la interfaz de bucle local. Se asume que el laboratorio
    está aislado y que no se manejan datos sensibles, aceptando el
    riesgo de tráfico en texto claro.
-   **Sin dependencias de nube**: las miniaturas, marcos y anotaciones
    se guardan en un sistema de archivos local montado por
    `Object Storage`. No se utiliza S3, MinIO ni bases de datos
    externas; por defecto se recomienda una base SQLite o PostgreSQL
    local para el Session Store.
-   **Sincronización de tiempo**: todos los componentes deben
    sincronizar sus relojes mediante NTP o utilizar el reloj del
    sistema. El Edge Agent genera marcas de tiempo de los frames (`ts`)
    y MediaMTX inserta etiquetas `PROGRAM‑DATE‑TIME` en las playlists.
    Se recomienda tolerar desajustes de ±100 ms para correlacionar
    detecciones con segmentos.
-   **Entornos de desarrollo**: la App UI puede ejecutarse como un
    servidor de desarrollo de Vue en el puerto 3000. Para pruebas E2E es
    recomendable servir la UI como archivos estáticos a través de un
    servidor HTTP simple.

### Próximos documentos

Este resumen se complementa con especificaciones detalladas por módulo,
contenidas en los archivos siguientes:

-   [`01-edge-agent.md`](./01-edge-agent.md) -- lógica de detección y
    control de sesiones.
-   [`02-mediamtx.md`](./02-mediamtx.md) -- configuración de MediaMTX
    para grabaciones HLS/fMP4.
-   [`03-session-store.md`](./03-session-store.md) -- persistencia de
    metadatos y API de consulta.
-   [`04-attribute-enricher.md`](./04-attribute-enricher.md) --
    enriquecimiento de atributos como color.
-   [`05-object-storage.md`](./05-object-storage.md) -- estructura de
    archivos para marcos y miniaturas.
-   [`06-app-ui.md`](./06-app-ui.md) -- vista del usuario y consumo de
    la API.
-   [`99-integration-e2e.md`](./99-integration-e2e.md) -- flujos de
    extremo a extremo y pruebas de aceptación.
